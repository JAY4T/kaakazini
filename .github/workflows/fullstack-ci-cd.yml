name: Full Stack CI/CD

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  ##########################
  # 0. Pre-Deploy Check
  ##########################
  precheck:
    name: ðŸ›¡ï¸ Pre-Deploy Check
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST_PROD: ${{ secrets.REMOTE_HOST_PROD }}
          REMOTE_HOST_STAGING: ${{ secrets.REMOTE_HOST_STAGING }}
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $REMOTE_HOST_PROD >> ~/.ssh/known_hosts
          ssh-keyscan -H $REMOTE_HOST_STAGING >> ~/.ssh/known_hosts

  ##########################
  # 1. Frontend Build & Deploy
  ##########################
  frontend:
    runs-on: ubuntu-latest
    needs: precheck
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm install --legacy-peer-deps
      - name: Build React App
        run: |
          # Create branch-specific frontend .env only during CI/CD
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "REACT_APP_API_BASE_URL=${{ secrets.REACT_APP_PROD_API_URL }}" > .env
          else
            echo "REACT_APP_API_BASE_URL=${{ secrets.REACT_APP_STAGING_API_URL }}" > .env
          fi
          CI=false npm run build
      - name: Deploy frontend
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST_PROD: ${{ secrets.REMOTE_HOST_PROD }}
          REMOTE_HOST_STAGING: ${{ secrets.REMOTE_HOST_STAGING }}
          FRONTEND_PATH_PROD: ${{ secrets.FRONTEND_PATH_PROD }}
          FRONTEND_PATH_STAGING: ${{ secrets.FRONTEND_PATH_STAGING }}
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            REMOTE_HOST=$REMOTE_HOST_PROD
            FRONTEND_PATH=$FRONTEND_PATH_PROD
          else
            REMOTE_HOST=$REMOTE_HOST_STAGING
            FRONTEND_PATH=$FRONTEND_PATH_STAGING
          fi

          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            build/ $REMOTE_USER@$REMOTE_HOST:$FRONTEND_PATH/

  ##########################
  # 2. Backend Build & Deploy
  ##########################
  backend:
    runs-on: ubuntu-latest
    needs: frontend
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: 3.12
      - run: pip install -r requirements.txt
      - name: Deploy backend (preserve .env)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST_PROD: ${{ secrets.REMOTE_HOST_PROD }}
          REMOTE_HOST_STAGING: ${{ secrets.REMOTE_HOST_STAGING }}
          BACKEND_PATH_PROD: ${{ secrets.BACKEND_PATH_PROD }}
          BACKEND_PATH_STAGING: ${{ secrets.BACKEND_PATH_STAGING }}
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $REMOTE_HOST_PROD >> ~/.ssh/known_hosts
          ssh-keyscan -H $REMOTE_HOST_STAGING >> ~/.ssh/known_hosts

          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            REMOTE_HOST=$REMOTE_HOST_PROD
            BACKEND_PATH=$BACKEND_PATH_PROD
            SERVICE_NAME=kaakazini.service
          else
            REMOTE_HOST=$REMOTE_HOST_STAGING
            BACKEND_PATH=$BACKEND_PATH_STAGING
            SERVICE_NAME=gunicorn-kaakazini-dev.service
          fi

          # Sync code but preserve server .env
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            --exclude='.git' --exclude='venv' --exclude='__pycache__' --exclude='.env' --delete \
            ./ $REMOTE_USER@$REMOTE_HOST:$BACKEND_PATH

          # Remote setup
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST << EOF
            cd $BACKEND_PATH
            echo "âœ… Preserving existing .env file"
            [ ! -d "venv" ] && python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput
            sudo systemctl restart $SERVICE_NAME
          EOF
